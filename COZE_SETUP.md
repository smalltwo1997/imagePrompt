# 扣子 (Coze) API 配置说明

## 功能介绍

本项目集成了扣子 (Coze) 工作流 API，用于实现图片转提示词功能。用户可以上传图片，系统会自动调用扣子的AI工作流来生成对应的图片描述提示词。

## 配置步骤

### 1. 获取扣子 API 凭证

1. 访问 [扣子开放平台](https://www.coze.cn/open)
2. 注册并登录账号
3. 创建应用，获取 API Token
4. 创建图片转提示词的工作流，获取 Workflow ID

### 2. 配置环境变量

在项目根目录的 `.env.local` 文件中添加以下配置：

```bash
# 扣子 API 配置
COZE_API_TOKEN="your_actual_coze_api_token"
COZE_WORKFLOW_ID="your_actual_workflow_id"
COZE_BOT_ID="your_actual_bot_id"  # 可选，如果使用Bot模式
```

### 3. 工作流配置要求

您的扣子工作流需要满足以下要求：

- **输入参数**: 工作流应接受名为 `image` 的文件ID参数
- **输出格式**: 工作流应返回包含提示词文本的结果
- **处理流程**:
  1. 接收图片文件ID
  2. 分析图片内容
  3. 生成详细的图片描述提示词
  4. 返回文本结果

### 4. API 端点说明

系统使用以下扣子 API 端点：

- **文件上传**: `POST https://api.coze.cn/v1/files/upload`
- **工作流运行**: `POST https://api.coze.cn/v1/workflow/run`
- **结果查询**: `GET https://api.coze.cn/v1/workflow/run/retrieve`

## 使用说明

### 前端使用

用户在 `/image-to-prompt` 页面可以：

1. 上传图片文件（支持 JPEG、PNG、WebP 格式，最大 10MB）
2. 选择不同的 AI 模型风格
3. 点击"生成提示词"按钮
4. 等待系统处理并显示生成的提示词
5. 复制或下载生成的提示词

### API 调用流程

1. **文件验证**: 检查文件类型和大小
2. **文件上传**: 将图片上传到扣子平台
3. **工作流启动**: 调用指定的工作流处理图片
4. **结果轮询**: 定期查询工作流执行状态
5. **返回结果**: 将生成的提示词返回给前端

## 错误处理

系统包含完整的错误处理机制：

- 文件格式验证
- 文件大小限制
- API 调用失败处理
- 超时处理（最多等待60秒）
- 友好的错误信息提示

## 开发和调试

### 本地测试

1. 确保已正确配置环境变量
2. 启动开发服务器：`bun run dev:web`
3. 访问 `http://localhost:3001/image-to-prompt`
4. 上传测试图片并查看控制台日志

### 日志查看

系统会输出详细的调试信息：

```javascript
// 在浏览器控制台或服务器日志中查看
console.log("文件上传结果:", uploadResult);
console.log("工作流执行状态:", statusResult);
```

## 注意事项

1. **API 限制**: 请注意扣子 API 的调用频率限制
2. **文件大小**: 建议上传的图片文件不超过 10MB
3. **处理时间**: 复杂图片的处理可能需要较长时间
4. **网络稳定性**: 确保服务器网络能稳定访问扣子 API

## 故障排除

### 常见问题

1. **"服务配置不完整"错误**
   - 检查 `.env.local` 中的 `COZE_API_TOKEN` 和 `COZE_WORKFLOW_ID` 是否正确配置

2. **"文件上传失败"错误**
   - 检查 API Token 是否有效
   - 确认网络连接正常
   - 验证文件格式是否支持

3. **"工作流执行超时"错误**
   - 检查工作流 ID 是否正确
   - 确认工作流是否正常运行
   - 考虑优化工作流处理速度

4. **"工作流执行失败"错误**
   - 检查工作流配置是否正确
   - 确认输入参数格式是否匹配
   - 查看扣子平台的工作流日志

### 联系支持

如果遇到问题，可以：

1. 查看扣子开放平台文档
2. 检查服务器和浏览器控制台的错误日志
3. 联系扣子平台技术支持

## 更新历史

- v1.0.0: 初始版本，支持基础的图片转提示词功能
- v1.1.0: 添加多种 AI 模型支持
- v1.2.0: 优化错误处理和用户体验